<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>訂單管理控制台 - 訂單列表</title>
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/myall.css">
  <link rel="stylesheet" href="./css/all.min.css">
  <style>
    .admin-panel-icon {
      position: fixed;
      right: 20px;
      top: 60%;
      transform: translateY(-50%);
      background-color: var(--mycolor04);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 1000;
      animation: pulse 2s infinite;
    }

    .admin-panel-icon i {
      font-size: 24px;
    }

    .admin-panel {
      position: fixed;
      top: 60%;
      right: -300px;
      width: 300px;
      background: #f8f9fa;
      padding: 20px;
      border: 1px solid #dee2e6;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transform: translateY(-50%);
      transition: right 0.3s;
      z-index: 999;
    }

    .admin-panel.show {
      right: 0;
    }

    #admin-options {
      list-style-type: none;
      padding: 0;
    }

    #admin-options li {
      margin-bottom: 15px;
    }

    #admin-options a {
      display: block;
      padding: 10px 15px;
      background-color: #f0f0f0;
      color: #333;
      text-decoration: none;
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    #admin-options a:hover {
      background-color: var(--mycolor04);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    @keyframes pulse {
      0% {
        transform: translateY(-50%) scale(1);
      }

      50% {
        transform: translateY(-50%) scale(1.1);
      }

      100% {
        transform: translateY(-50%) scale(1);
      }
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-dark navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">訂單管理控制</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">

          <li class="nav-item">
            <a class="nav-link " aria-current="page" href="./product_order_index.html">新增訂單</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="./product_order_table.html">訂單列表</a>
          </li>
          <li class="nav-item">
            <a class="nav-link " aria-current="page" href="./index.html">回首頁</a>
          </li>
        </ul>
        <form class="d-flex" role="search">
          <button class="btn btn-secondary d-none" id="s02_logout_btn">登出</button>
          <span class="text-danger h1" id="s02_user_text"></span>

        </form>
      </div>
    </div>
  </nav>
  <div id="admin-panel-icon" class="admin-panel-icon">
    <i class="fas fa-cogs"></i>
    <span id="admin-panel-indicator"></span>
  </div>

  <div id="admin-panel" class="admin-panel">
    <h5>管理面板</h5>
    <ul id="admin-options">
      <li><a href="./product_table.html" target="_blank">產品管理</a></li>
      <li><a href="./meet_table.html" target="_blank">預約管理</a></li>
      <li><a href="./product_order_table.html" target="_blank">訂單管理</a></li>
    </ul>
  </div>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-10 pt-5">
        <table class="table table-striped  table-bordered table-rwd">
          <caption>訂單列表</caption>
          <thead>
            <tr>
              <th>訂單編號</th>
              <th>總金額</th>
              <th>訂單時間</th>
              <th>-</th>
            </tr>
          </thead>
          <tbody id="orderTableBody">
            <tr>
              <td>001</td>
              <td>1000</td>
              <td>2024-07-17 10:30:00</td>
              <td>
                <button class="btn btn-sm btn-primary">更新</button>
                <button class="btn btn-sm btn-danger">刪除</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- updateModal -->
  <div class="modal fade" id="updateOrderModal" tabindex="-1" aria-labelledby="updateOrderModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="updateOrderModalLabel">更新訂單</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="updateOrderForm">
            <input type="hidden" id="updateOrderId">
            <div id="orderItems">
              <!-- 訂單項目將在這裡動態插入 -->
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          <button type="button" class="btn btn-primary" id="confirmUpdate">確認更新</button>
        </div>
      </div>
    </div>
  </div>

  <script src="./js/bootstrap.bundle.min.js"></script>
  <script src="./js/jquery-3.7.1.min.js"></script>
  <script>
    $(document).ready(function () {
      //檢查cookie 是否已存在uid 並確認是否合法
      if (getCookie("UID01") != "" && getCookie("UID02") != "" && getCookie("UID03") != "") {
        //uid傳至後端檢查是否合法
        //轉換成json格式
        var dataJSON = {}; //物件                        
        dataJSON["uid01"] = getCookie("UID01");
        dataJSON["uid02"] = getCookie("UID02");
        dataJSON["uid03"] = getCookie("UID03");

        console.log(JSON.stringify(dataJSON));

        //傳遞至後端api
        $.ajax({
          type: "POST",
          url: "http://upupcoffee.infinityfreeapp.com/member_check_uid-api.php",
          data: JSON.stringify(dataJSON),
          contentType: "application/json;charset=utf-8",
          dataType: "json",
          success: showdata_check_uid,
          error: function () {
            alert("error-member_check_uid-api.php");
          }
        });
      } else {
        alert("必須先登入會員!");
        location.href = "index.html";
      }

      //登出按鈕監聽 s02_logout_btn 清除value並跳回首頁
      $("#s02_logout_btn").click(function () {
        setCookie("UID01", "", 7);
        setCookie("UID02", "", 7);
        setCookie("UID03", "", 7);
        location.href = "index.html";
      });

      function showdata_check_uid(data) {
        console.log(data);
        if (data.state) {
          //顯示登入者歡迎資訊
          $("#s02_user_text").html('歡迎會員: <span class="h2 fw-900 text-success">' + data.data.Username + '</span>');

          //顯示登出按鈕
          $("#s02_logout_btn").removeClass("d-none");
        } else {
          location.href = "index.html";

        }
      }
      //from w3c
      function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        let expires = "expires=" + d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
      }

      function getCookie(cname) {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) == ' ') {
            c = c.substring(1);
          }
          if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
          }
        }
        return "";
      }


      let allOrders = []; // 用於存儲所有訂單資料

      loadOrders();

      // 加載訂單
      function loadOrders() {
        $.ajax({
          url: 'http://upupcoffee.infinityfreeapp.com/order_R_api.php',
          type: 'GET',
          dataType: 'json',
          success: function (response) {
            if (response.state) {
              allOrders = response.data;
              let tableBody = '';
              response.data.forEach(order => {
                tableBody += `
                  <tr><td data-th="訂單編號">${order.order_id}</td><td data-th="$$">${order.total_amount}</td><td data-th="訂單時間">${order.order_date}</td><td><button class="btn btn-outline-info w-100 mb-2 expandOrder" data-id="${order.order_id}">展開</button><button class="btn btn-outline-success w-100 mb-2 updateOrder" data-id="${order.order_id}">修改</button><button class="btn btn-outline-danger w-100 mb-2 deleteOrder" data-id="${order.order_id}">刪除</button></td></tr><tr class="order-details" id="details-${order.order_id}" style="display:none;"><td colspan="4"><table class="table table-sm"><thead><tr><th>產品名稱</th><th>數量</th><th>單價</th></tr></thead><tbody>${order.items.map(item => `<tr><td>${item.name}</td><td>${item.quantity}</td><td>${item.price}</td></tr>`).join('')}</tbody></table></td></tr>`;
              });
              $('#orderTableBody').html(tableBody);
            } else {
              alert('載入訂單失敗：' + response.message);
            }
          },
          error: function () {
            alert('載入訂單時發生錯誤');
          }
        });
      }

      // 展開訂單詳情
      $(document).on('click', '.expandOrder', function () {
        let orderId = $(this).data('id');
        $(`#details-${orderId}`).toggle();
      });

      // 更新訂單
      $(document).on('click', '.updateOrder', function () {
        let orderId = $(this).data('id');
        $('#updateOrderId').val(orderId);

        let order = allOrders.find(o => o.order_id == orderId);
        if (order) {
          let itemsHtml = '';
          order.items.forEach((item, index) => {
            itemsHtml += `
                    <div class="form-group mb-3">
                        <label class="form-label">${item.name}</label>
                        <input type="number" class="form-control" name="quantity_${index}" value="${item.quantity}" min="1" required>
                        <input type="hidden" name="id_${index}" value="${item.product_id}">
                        <input type="hidden" name="price_${index}" value="${item.price}">
                    </div>
                `;
          });
          $('#orderItems').html(itemsHtml);
          var updateOrderModal = new bootstrap.Modal(document.getElementById('updateOrderModal'));
          updateOrderModal.show();
        }
      });

      // 確認更新按鈕功能
      $('#confirmUpdate').click(function () {
        let orderId = $('#updateOrderId').val();
        let items = [];
        $('#orderItems input[name^="quantity_"]').each(function (index) {
          items.push({
            id: $(`input[name="id_${index}"]`).val(),
            quantity: $(this).val(),
            price: $(`input[name="price_${index}"]`).val()
          });
        });

        $.ajax({
          url: 'http://upupcoffee.infinityfreeapp.com/order_U_api.php',
          type: 'POST',
          dataType: 'json',
          data: JSON.stringify({
            order_id: orderId,
            items: items
          }),
          contentType: 'application/json',
          success: function (response) {
            if (response.state) {
              alert('訂單更新成功');
              var updateOrderModal = bootstrap.Modal.getInstance(document.getElementById('updateOrderModal'));
              updateOrderModal.hide();
              loadOrders();  // 重新加載訂單列表
            } else {
              alert('訂單更新失敗：' + response.message);
            }
          },
          error: function () {
            alert('更新訂單時發生錯誤');
          }
        });
      });

      // 刪除訂單
      $(document).on('click', '.deleteOrder', function () {
        if (confirm('確定要刪除這個訂單嗎？')) {
          let orderId = $(this).data('id');
          $.ajax({
            url: 'http://upupcoffee.infinityfreeapp.com/order_D_api.php',
            type: 'POST',
            dataType: 'json',
            data: JSON.stringify({ order_id: orderId }),
            contentType: 'application/json',
            success: function (response) {
              if (response.state) {
                alert('訂單刪除成功');
                loadOrders();
              } else {
                alert('訂單刪除失敗：' + response.message);
              }
            },
            error: function () {
              alert('刪除訂單時發生錯誤');
            }
          });
        }
      });
    });

    $(document).ready(function () {
      $("#admin-panel-icon").on("click", function () {
        $("#admin-panel").toggleClass("show");
      });

      $("#admin-options a").on("click", function (e) {
        e.preventDefault();
        var url = $(this).attr("href");
        window.open(url, '_self');
      });

      // 點擊面板外的區域時關閉面板
      $(document).on("click", function (event) {
        if (!$(event.target).closest("#admin-panel").length &&
          !$(event.target).closest("#admin-panel-icon").length) {
          $("#admin-panel").removeClass("show");
        }
      });
    });
  </script>
</body>

</html>