<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>產品管理控制台 - 產品列表</title>
  <link rel="stylesheet" href="./css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/myall.css">
  <link rel="stylesheet" href="./css/all.min.css">
  <style>
    .admin-panel-icon {
      position: fixed;
      right: 20px;
      top: 60%;
      transform: translateY(-50%);
      background-color: var(--mycolor04);
      color: white;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      z-index: 1000;
      animation: pulse 2s infinite;
    }

    .admin-panel-icon i {
      font-size: 24px;
    }

    .admin-panel {
      position: fixed;
      top: 60%;
      right: -300px;
      width: 300px;
      background: #f8f9fa;
      padding: 20px;
      border: 1px solid #dee2e6;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      transform: translateY(-50%);
      transition: right 0.3s;
      z-index: 999;
    }

    .admin-panel.show {
      right: 0;
    }

    #admin-options {
      list-style-type: none;
      padding: 0;
    }

    #admin-options li {
      margin-bottom: 15px;
    }

    #admin-options a {
      display: block;
      padding: 10px 15px;
      background-color: #f0f0f0;
      color: #333;
      text-decoration: none;
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    #admin-options a:hover {
      background-color: var(--mycolor04);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    @keyframes pulse {
      0% {
        transform: translateY(-50%) scale(1);
      }

      50% {
        transform: translateY(-50%) scale(1.1);
      }

      100% {
        transform: translateY(-50%) scale(1);
      }
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-dark navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">產品管理控制</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link " aria-current="page" href="./product_index.html">新增產品</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="./product_table.html">產品列表</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="./index.html">回首頁</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Dropdown
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">Action</a></li>
              <li><a class="dropdown-item" href="#">Another action</a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item" href="#">Something else here</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link disabled">Disabled</a>
          </li>
        </ul>
        <form class="d-flex" role="search">
          <button class="btn btn-secondary d-none" id="s02_logout_btn">登出</button>
          <span class="text-danger h1" id="s02_user_text"></span>

        </form>
      </div>
    </div>
  </nav>
  <div id="admin-panel-icon" class="admin-panel-icon">
    <i class="fas fa-cogs"></i>
    <span id="admin-panel-indicator"></span>
  </div>

  <div id="admin-panel" class="admin-panel">
    <h5>管理面板</h5>
    <ul id="admin-options">
      <li><a href="./product_table.html" target="_blank">產品管理</a></li>
      <li><a href="./meet_table.html" target="_blank">預約管理</a></li>
      <li><a href="./product_order_table.html" target="_blank">訂單管理</a></li>
    </ul>
  </div>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-10 pt-5">
        <table class="table table-striped table-bordered table-rwd">
          <caption>產品列表</caption>
          <thead>
            <tr>
              <th>產品編號</th>
              <th>產品圖片</th>
              <th>產品名稱</th>
              <th>產品價格</th>
              <th>產品數量</th>
              <th>產品備註</th>
              <th>建檔時間</th>
              <th>-</th>
            </tr>
          </thead>
          <tbody id="mydata">
            <tr>
              <td data-th="產品編號">001</td>
              <td data-th="產品圖片"><img
                  src="https://plus.unsplash.com/premium_photo-1671405925193-39b5ef30c026?q=80&w=1935&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D"
                  width="150px" alt=""></td>
              <td data-th="產品名稱">冰淇淋</td>
              <td data-th="產品價格">80</td>
              <td data-th="產品數量">20</td>
              <td data-th="產品備註">甜</td>
              <td data-th="建檔時間">2024-06-03 11:55:23</td>
              <td>
                <button class="btn btn-outline-success w-100 mb-2" data-bs-toggle="modal"
                  data-bs-target="#updateModal">更新</button>
                <button class="btn btn-outline-danger w-100">刪除</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- updateModal -->
  <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="exampleModalLabel">產品更新</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="pname" class="form-label">產品名稱</label>
            <input type="text" name="pname" id="pname" class="form-control" placeholder="字數2~5">
            <div class="valid-feedback">符合規定</div>
            <div class="invalid-feedback">不符合規定</div>
          </div>
          <div class="mb-3">
            <label for="price" class="form-label">產品價格(元)</label>
            <input type="number" name="price" id="price" class="form-control" placeholder="1~1000(元)">
            <div class="valid-feedback">符合規定</div>
            <div class="invalid-feedback">不符合規定</div>
          </div>
          <div class="mb-3">
            <label for="pnum" class="form-label">產品數量(個)</label>
            <input type="number" name="pnum" id="pnum" class="form-control" placeholder="1~100個" disabled>
            <div class="valid-feedback">符合規定</div>
            <div class="invalid-feedback">不符合規定</div>
          </div>
          <div class="mb-3">
            <label for="premark" class="form-label">產品備註</label>
            <textarea name="premark" id="premark" class="form-control" placeholder="字數2~10" disabled></textarea>
            <div class="valid-feedback">符合規定</div>
            <div class="invalid-feedback">不符合規定</div>
          </div>
          <div class="mb-3">
            <label for="pimg" class="form-label">產品圖片(路徑)</label>
            <input type="text" name="pimg" id="pimg" class="form-control" disabled>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          <button type="button" class="btn btn-primary" id="btn_update_updateModal">確認更新</button>
        </div>
      </div>
    </div>
  </div>


  <script src="./js/bootstrap.bundle.min.js"></script>
  <script src="./js/jquery-3.7.1.min.js"></script>
  <script>
    var flag_pname = true;
    var flag_price = true;

    var u_id;

    $(function () {
      //檢查cookie 是否已存在uid 並確認是否合法
      if (getCookie("UID01") != "" && getCookie("UID02") != "" && getCookie("UID03") != "") {
        //uid傳至後端檢查是否合法
        //轉換成json格式
        var dataJSON = {}; //物件                        
        dataJSON["uid01"] = getCookie("UID01");
        dataJSON["uid02"] = getCookie("UID02");
        dataJSON["uid03"] = getCookie("UID03");

        console.log(JSON.stringify(dataJSON));

        //傳遞至後端api
        $.ajax({
          type: "POST",
          url: "http://upupcoffee.infinityfreeapp.com/member_check_uid-api.php",
          data: JSON.stringify(dataJSON),
          contentType: "application/json;charset=utf-8",
          dataType: "json",
          success: showdata_check_uid,
          error: function () {
            alert("error-member_check_uid-api.php");
          }
        });
      } else {
        alert("必須先登入會員!");
        location.href = "index.html";
      }


      //串接product_R
      $.ajax({
        type: "GET",
        url: "http://upupcoffee.infinityfreeapp.com/product_R_api.php",
        dataType: "json",
        async: false,
        success: showdata,
        error: function () {
          alert("error-product_R_api.php");
        }
      });

      //#btn_update 監聽 關聯到ajax時要把最後跑的ajax先打開
      //需要寫兩層
      $("#mydata #btn_update").click(function () {
        // console.log("test");
        console.log($(this).data("id"));
        console.log($(this).data("pname"));
        console.log($(this).data("price"));
        console.log($(this).data("pnum"));
        console.log($(this).data("premark"));
        console.log($(this).data("pimg"));
        console.log($(this).data("created_at"));

        //更新update Model表單
        $("#pname").val($(this).data("pname"));
        $("#price").val($(this).data("price"));
        $("#pnum").val($(this).data("pnum"));
        $("#premark").val($(this).data("premark"));
        $("#pimg").val($(this).data("pimg"));

        u_id = $(this).data("id");
      });

      //刪除 #btn_delete 監聽
      $("#mydata #btn_delete").click(function () {
        if (confirm("確認刪除此筆資料？")) {
          if (confirm("真的刪除此筆資料？")) {
            if (confirm("按下去資料就掰掰囉？(╯‵□′)╯︵┴─┴")) {
              console.log($(this).data("id"));

              //傳遞至後端API 更新
              //轉換成json格式
              var dataJSON = {}; //物件
              dataJSON["ID"] = $(this).data("id");
              console.log(JSON.stringify(dataJSON));
              //傳遞至後端api
              $.ajax({
                type: "POST",
                url: "http://upupcoffee.infinityfreeapp.com/product_D_api.php",
                data: JSON.stringify(dataJSON),
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: showdata_delete,
                error: function () {
                  alert("error-product_D_api.php");
                }
              });
            }
          }
        }

      });


      //即時監聽pname 字數2~5
      $("#pname").bind("input propertychange", function () {
        // console.log($(this).val());
        if ($(this).val().length > 1 && $(this).val().length < 6) {
          //符合規定
          $(this).removeClass("is-invalid");
          $(this).addClass("is-valid");
          flag_pname = true;
        } else {
          //不符合規定
          $(this).removeClass("is-valid");
          $(this).addClass("is-invalid");
          flag_pname = false;
        }
      });
      //即時監聽price 1~1000(元)
      $("#price").bind("input propertychange", function () {
        if ($(this).val() > 0 && $(this).val() < 1001) {
          $(this).removeClass("is-invalid");
          $(this).addClass("is-valid");
          flag_price = true;
        } else {
          $(this).removeClass("is-valid");
          $(this).addClass("is-invalid");
          flag_price = false;
        }
      });

      //監聽 #btn_update_updateModal
      $("#btn_update_updateModal").click(function () {
        if (flag_pname && flag_price) {
          console.log($("#pname").val());
          console.log($("#price").val());
          //傳遞至後端API 更新
          //轉換成json格式
          var dataJSON = {}; //物件
          dataJSON["ID"] = u_id;
          dataJSON["pname"] = $("#pname").val();
          dataJSON["price"] = $("#price").val();
          console.log(JSON.stringify(dataJSON));

          //傳遞至後端api
          $.ajax({
            type: "POST",
            url: "http://upupcoffee.infinityfreeapp.com/product_U_api.php",
            data: JSON.stringify(dataJSON),
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: showdata_update,
            error: function () {
              alert("error-product_U_api.php");
            }
          });


        } else {
          alert("欄位錯誤，請修正！");
        }
      });

      //登出按鈕監聽 s02_logout_btn 清除value並跳回首頁
      $("#s02_logout_btn").click(function () {
        setCookie("UID01", "", 7);
        setCookie("UID02", "", 7);
        setCookie("UID03", "", 7);
        location.href = "index.html";
      });
    });

    function showdata(data) {
      console.log(data);

      if (data.state) {
        //alert(data.message); //讀取成功 這個可以隱藏

        $("#mydata").empty();
        data.data.forEach(function (item) {
          var strHTML = '<tr><td data-th="產品編號">' + item.ID + '</td><td data-th="產品圖片"><img src="' + item.Pimg + '" width="150px" alt=""></td><td data-th="產品名稱">' + item.Pname + '</td><td data-th="產品價格">' + item.Price + '</td><td data-th="產品數量">' + item.Pnum + '</td><td data-th="產品備註">' + item.Premark + '</td><td data-th="建檔時間">' + item.Created_at + '</td><td><button class="btn btn-outline-success w-100 mb-2" data-bs-toggle="modal" data-bs-target="#updateModal" data-id="' + item.ID + '" data-pname="' + item.Pname + '" data-price="' + item.Price + '" data-pnum="' + item.Pnum + '" data-premark="' + item.Premark + '" data-pimg="' + item.Pimg + '" data-created_at="' + item.Created_at + '" id="btn_update">更新</button><button class="btn btn-outline-danger w-100" data-id="' + item.ID + '" id="btn_delete">刪除</button></td></tr>';

          $("#mydata").append(strHTML);
        });
      } else {
        alert(data.message);
      }
    }

    function showdata_update(data) {
      console.log(data);
      if (data.state) {
        alert(data.message);
        location.href = "product_table.html";
      } else {
        alert(data.message);
      }
    }

    function showdata_delete(data) {
      console.log(data);
      if (data.state) {
        alert(data.message);
        location.href = "product_table.html";
      } else {
        alert(data.message);
      }
    }

    function showdata_check_uid(data) {
      console.log(data);
      if (data.state) {
        //顯示登入者歡迎資訊
        $("#s02_user_text").html('歡迎會員: <span class="h2 fw-900 text-success">' + data.data.Username + '</span>');

        //顯示登出按鈕
        $("#s02_logout_btn").removeClass("d-none");
      } else {
        location.href = "index.html";

      }
    }



    //from w3c
    function setCookie(cname, cvalue, exdays) {
      const d = new Date();
      d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
      let expires = "expires=" + d.toUTCString();
      document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
      let name = cname + "=";
      let decodedCookie = decodeURIComponent(document.cookie);
      let ca = decodedCookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
          c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
          return c.substring(name.length, c.length);
        }
      }
      return "";
    }

    $(document).ready(function () {
      $("#admin-panel-icon").on("click", function () {
        $("#admin-panel").toggleClass("show");
      });

      $("#admin-options a").on("click", function (e) {
        e.preventDefault();
        var url = $(this).attr("href");
        window.open(url, '_self');
      });

      // 點擊面板外的區域時關閉面板
      $(document).on("click", function (event) {
        if (!$(event.target).closest("#admin-panel").length &&
          !$(event.target).closest("#admin-panel-icon").length) {
          $("#admin-panel").removeClass("show");
        }
      });
    });

  
  </script>
</body>

</html>